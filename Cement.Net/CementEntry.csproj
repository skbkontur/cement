<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <RootNamespace>cm</RootNamespace>
    <AssemblyName>Cement</AssemblyName>
    <TargetFramework>net472</TargetFramework>
    <Product>Cement.Net</Product>
    <Copyright>Copyright ©  2019</Copyright>
    <Version>4.1.0</Version>
    <BuildDependsOn>$(BuildDependsOn);AfterBuildMigrated</BuildDependsOn>
    <OutputPath>bin\$(Configuration)\</OutputPath>
  </PropertyGroup>


  <Target Name="Merge" AfterTargets="Build">
     <ItemGroup>
      <MergeAssemblies Include="$(OutputPath)\Cement.exe" />
      <MergeAssemblies Include="$(OutputPath)\Commands.dll" />
      <MergeAssemblies Include="$(OutputPath)\Common.dll" />
      <MergeAssemblies Include="$(OutputPath)\NDesk.Options.dll" />
      <MergeAssemblies Include="$(OutputPath)\SharpYaml.dll" />
      <MergeAssemblies Include="$(SolutionDir)\externals\log4stash.dll" />
      <MergeAssemblies Include="$(OutputPath)\NuGet.exe" />
      <MergeAssemblies Include="$(OutputPath)\JetBrains.Annotations.dll" />
    </ItemGroup>
    <PropertyGroup>
      <OutputAssembly>$(OutputPath)\cm.exe</OutputAssembly>
      <Merger>"$(SolutionDir)\packages\ILRepack.1.26.0\tools\ILRepack.exe"</Merger>
    </PropertyGroup>
    <Message Text="MERGING: @(MergeAssemblies-&gt;'%(Filename)') into $(OutputAssembly)" Importance="High" />
    <Exec Command="$(Merger) /out:&quot;$(OutputAssembly)&quot; @(MergeAssemblies-&gt;'&quot;%(FullPath)&quot;', ' ')" />
  </Target>

  <Target Name="CopyExe" AfterTargets="Build" DependsOnTargets="Merge" Condition="'$(OS)' != 'Unix'">

    <Message Text="OLOLO" Importance="High" />

    <Exec Command="rmdir /S /Q %25userprofile%25\bin\dotnet" />
    <Exec Command="mkdir %25userprofile%25\bin\dotnet" />
    <Exec Command="copy $(OutputAssembly) %25userprofile%25\bin\dotnet\cm.exe" />
    <Exec Command="copy $(OutputAssembly).config %25userprofile%25\bin\dotnet\cm.exe.config" />
    <Exec Command="xcopy $(SolutionDir)\files-common %25userprofile%25\bin\dotnet /s /i /Y" />
    <Exec Condition="Exists('$(SolutionDir)\files-kontur')" Command="xcopy $(SolutionDir)\files-kontur %25userprofile%25\bin\dotnet /s /i /Y" />
    <Exec Command="$(OutputAssembly) help --gen $(SolutionDir)\README-commands.md" />
  </Target>
  <Target Name="CopyExeUnix" DependsOnTargets="Merge" Condition="'$(OS)' == 'Unix'">
    <Exec Command="rm -rf ~/bin/dotnet" />
    <Exec Command="mkdir ~/bin/dotnet" />
    <Exec Command="cp $(OutputAssembly) ~/bin/dotnet/cm.exe" />
    <Exec Command="cp $(OutputAssembly).config ~/bin/dotnet/cm.exe.config" />
    <Exec Command="cp -R $(SolutionDir)/files-common/* ~/bin/dotnet" />
    <Exec Condition="Exists('$(SolutionDir)/files-kontur')" Command="cp -R $(SolutionDir)/files-kontur/* ~/bin/dotnet" />
  </Target>
  <ItemGroup>
    <PackageReference Include="ILRepack" Version="1.26.0" />
    <PackageReference Include="JetBrains.Annotations" Version="2019.1.1" />
    <PackageReference Include="ManyConsole" Version="0.4.2.17" />
    <PackageReference Include="Microsoft.Extensions.Configuration" Version="3.0.0" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Abstractions" Version="3.0.0" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Binder" Version="3.0.0" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="3.0.0" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection.Abstractions" Version="3.0.0" />
    <PackageReference Include="Microsoft.Extensions.Logging" Version="3.0.0" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="3.0.0" />
    <PackageReference Include="Microsoft.Extensions.Options" Version="3.0.0" />
    <PackageReference Include="Microsoft.Extensions.Primitives" Version="3.0.0" />
    <PackageReference Include="NDesk.Options" Version="0.2.1" />
    <PackageReference Include="NSubstitute" Version="1.8.1.0" />
    <PackageReference Include="System.Buffers" Version="4.4.0" />
    <PackageReference Include="System.ComponentModel.Annotations" Version="4.6.0" />
    <PackageReference Include="System.Memory" Version="4.5.2" />
    <PackageReference Include="System.Numerics.Vectors" Version="4.4.0" />
    <PackageReference Include="System.Runtime.CompilerServices.Unsafe" Version="4.6.0" />
  </ItemGroup>
  <ItemGroup>
    <Reference Include="System.ComponentModel.DataAnnotations" />
  </ItemGroup>
  <ItemGroup>
    <ProjectReference Include="..\Commands\Commands.csproj" />
    <ProjectReference Include="..\Common\Common.csproj" />
  </ItemGroup>
</Project>